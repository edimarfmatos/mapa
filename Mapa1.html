<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mapa do Depósito — Visão Aérea (Leaflet)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    #map { position:fixed; inset:0; }
    .topright-panel {
      position: absolute; top: 10px; right: 10px; z-index: 1000;
      background: rgba(255,255,255,0.9); padding: 8px; border-radius:8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-family: sans-serif;
    }
    .btn { display:inline-block; margin:4px; padding:6px 8px; border-radius:6px; cursor:pointer; user-select:none; }
    .status { position:absolute; left:10px; bottom:10px; z-index:1000; background:rgba(255,255,255,0.9); padding:6px 8px; border-radius:6px; font-family:sans-serif; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topright-panel" id="controls">
    <div>
      <span class="btn" id="zoom10">Visão ~10m</span>
      <span class="btn" id="zoom20">Visão ~20m</span>
      <span class="btn" id="follow">Seguir: OFF</span>
    </div>
    <div style="margin-top:6px; font-size:13px; color:#333">Centro inicial: localização atual</div>
  </div>
  <div class="status" id="status">Status: aguardando GPS...</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script>
    const APPS_SCRIPT_URL = 'REPLACE_WITH_YOUR_APPS_SCRIPT_WEBAPP_URL';
    const SYNC_INTERVAL = 5000;
    const map = L.map('map', { zoomControl:true }).setView([0, 0], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22, attribution: '© OpenStreetMap' }).addTo(map);
    const drawingsLayer = L.geoJSON(null, { onEachFeature: (feature, layer) => {
      if (feature.properties) {
        let popup = '';
        if (feature.properties.cte) popup += '<b>CTE:</b> ' + feature.properties.cte + '<br>';
        if (feature.properties.loc) popup += '<b>Loc:</b> ' + feature.properties.loc + '<br>';
        if (popup) layer.bindPopup(popup);
      }
    }}).addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems, remove:true }, draw: { circle:false, circlemarker:false } });
    map.addControl(drawControl);
    const userMarker = L.circleMarker([0,0], { radius:8, color:'blue' }).addTo(map);
    userMarker.bindPopup('Você').openPopup();
    let follow = false;
    document.getElementById('zoom10').onclick = ()=> map.setZoom(19);
    document.getElementById('zoom20').onclick = ()=> map.setZoom(17);
    const followBtn = document.getElementById('follow');
    followBtn.onclick = ()=> { follow = !follow; followBtn.textContent = 'Seguir: ' + (follow ? 'ON' : 'OFF'); }
    const statusEl = document.getElementById('status');
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 18);
        userMarker.setLatLng([latitude, longitude]);
        statusEl.textContent = 'GPS inicializado — você está aqui!';
      }, err => { statusEl.textContent = 'Não foi possível obter a localização inicial.'; });
      navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        userMarker.setLatLng([latitude, longitude]);
        userMarker.bindPopup(`Você<br>Lat: ${latitude.toFixed(6)}<br>Lng: ${longitude.toFixed(6)}`);
        statusEl.textContent = `GPS ativo — precisão: ${accuracy ? accuracy.toFixed(1)+'m':'n/d'}`;
        if (follow) map.panTo([latitude, longitude]);
      }, err => { statusEl.textContent = 'Status: GPS indisponível ou não permitido.'; }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
    } else {
      statusEl.textContent = 'Geolocalização não suportada pelo navegador.';
    }
    map.on(L.Draw.Event.CREATED, e => {
      const layer = e.layer;
      const cte = prompt('Digite o número do CTE (opcional):') || '';
      const loc = prompt('Digite o número da locação (opcional):') || '';
      layer.feature = layer.feature || { type: 'Feature', properties: {} };
      layer.feature.properties.cte = cte;
      layer.feature.properties.loc = loc;
      drawnItems.addLayer(layer);
      const geo = layer.toGeoJSON();
      geo.properties.cte = cte;
      geo.properties.loc = loc;
      saveDrawingToSheet(geo);
    });
    map.on('draw:edited', e => { e.layers.eachLayer(layer => saveDrawingToSheet(layer.toGeoJSON(), true)); });
    map.on('draw:deleted', e => { e.layers.eachLayer(layer => deleteDrawingFromSheet(layer.toGeoJSON())); });
    async function saveDrawingToSheet(geojson, isUpdate=false) {
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('REPLACE_WITH')) {
        const stored = JSON.parse(localStorage.getItem('drawings') || '[]');
        stored.push({ id: Date.now().toString(), geojson });
        localStorage.setItem('drawings', JSON.stringify(stored));
        return;
      }
      try {
        await fetch(APPS_SCRIPT_URL, { method: 'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ action:'save', geojson }) });
      } catch (err) { console.error('Erro ao salvar no Apps Script', err); }
    }
    async function deleteDrawingFromSheet(geojson) {
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('REPLACE_WITH')) {
        const stored = JSON.parse(localStorage.getItem('drawings') || '[]');
        const serialized = JSON.stringify(geojson.geometry);
        const filtered = stored.filter(s => JSON.stringify(s.geojson.geometry) !== serialized);
        localStorage.setItem('drawings', JSON.stringify(filtered));
        return;
      }
      try {
        await fetch(APPS_SCRIPT_URL, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'delete', geojson }) });
      } catch (err) { console.error('Erro delete', err); }
    }
    async function loadDrawingsFromSheet() {
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('REPLACE_WITH')) {
        const stored = JSON.parse(localStorage.getItem('drawings') || '[]');
        drawingsLayer.clearLayers();
        stored.forEach(s => drawingsLayer.addData(s.geojson));
        return;
      }
      try {
        const resp = await fetch(APPS_SCRIPT_URL + '?action=get');
        const data = await resp.json();
        drawingsLayer.clearLayers();
        data.forEach(item => drawingsLayer.addData(item.geojson));
      } catch (err) { console.error('Erro ao carregar desenhos', err); }
    }
    loadDrawingsFromSheet();
    setInterval(loadDrawingsFromSheet, SYNC_INTERVAL);
  </script>
</body>
</html>